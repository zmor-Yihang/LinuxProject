# 设置源文件名和目标模块名
TARGET_NAME := param
SOURCE_FILE := $(TARGET_NAME).c

# 告诉内核构建系统要编译源文件，生成内核模块
obj-m += $(TARGET_NAME).o

# 设置内核源码目录路径，使用当前系统的内核头文件
KDIR := /lib/modules/$(shell uname -r)/build

# 获取当前工作目录（即驱动源码所在目录）
PWD ?= $(shell pwd)

# 设置输出目录
OUTPUT_DIR := $(PWD)/build_x86

# 添加C99标准支持，覆盖内核默认的gnu89标准
ccflags-y := -std=gnu99

# 编译目标：编译内核模块
# -C：切换到内核源码目录执行make
# M=$(PWD)：告诉内核构建系统驱动源码的位置
# modules：编译模块（.ko文件）
all:
	@echo "创建输出目录: $(OUTPUT_DIR)"
	@mkdir -p $(OUTPUT_DIR)
	@echo "开始编译x86内核模块..."
	make -C $(KDIR) M=$(PWD) modules
	@echo "移动编译输出到 $(OUTPUT_DIR) 目录..."
	@mv $(PWD)/*.o $(OUTPUT_DIR)/ 2>/dev/null || true
	@mv $(PWD)/*.ko $(OUTPUT_DIR)/ 2>/dev/null || true
	@mv $(PWD)/*.mod $(OUTPUT_DIR)/ 2>/dev/null || true
	@mv $(PWD)/*.mod.c $(OUTPUT_DIR)/ 2>/dev/null || true
	@mv $(PWD)/*.mod.o $(OUTPUT_DIR)/ 2>/dev/null || true
	@mv $(PWD)/Module.symvers $(OUTPUT_DIR)/ 2>/dev/null || true
	@mv $(PWD)/modules.order $(OUTPUT_DIR)/ 2>/dev/null || true
	@mv $(PWD)/.*.d $(OUTPUT_DIR)/ 2>/dev/null || true
	@echo "清理中间文件..."
	@rm -f $(PWD)/.*.cmd
	@echo "编译完成！输出文件在 $(OUTPUT_DIR) 目录中"

# 清理目标：删除编译生成的文件
clean:
	@echo "清理编译输出..."
	@rm -rf $(OUTPUT_DIR)
	@make -C $(KDIR) M=$(PWD) clean
	@echo "清理完成！"

# 显示编译输出目录
show:
	@echo "编译输出目录: $(OUTPUT_DIR)"
	@echo "当前源文件: $(PWD)/$(SOURCE_FILE)"
	@echo "目标模块名: $(TARGET_NAME).ko"
	@ls -la $(OUTPUT_DIR) 2>/dev/null || echo "目录不存在，请先编译"

# 安装模块到系统
install: all
	@echo "安装模块到系统..."
	sudo insmod $(OUTPUT_DIR)/$(TARGET_NAME).ko
	@echo "模块已安装，可以使用以下命令查看："
	@echo "  lsmod | grep $(TARGET_NAME)"
	@echo "  dmesg | tail"

# 卸载模块
uninstall:
	@echo "卸载模块..."
	sudo rmmod $(TARGET_NAME)
	@echo "模块已卸载"